<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>SMISWS Client - Socket.IO</title>
    <style type="text/css">
      html,
      body {
        height: 98%;
        padding: 0;
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
      }

      h1 {
        color: #333;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 20px;
        margin: 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        font-size: 20px;
      }

      .ui-txt {
        width: 400px;
        padding: 5px 8px;
        border: 1px solid #ddd;
        border-radius: 3px;
        font-size: 13px;
      }

      .ui-cntnr {
        padding: 10px 15px;
        background: white;
        margin: 8px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .ui-cntnr > input {
        display: inline-block;
        margin-right: 10px;
      }

      .log-container {
        margin: 8px;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 280px);
        min-height: 500px;
      }

      .log-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: white;
        border: 2px solid #ddd;
        border-bottom: none;
        border-radius: 6px 6px 0 0;
      }

      .log-controls h3 {
        margin: 0;
        color: #333;
        font-size: large;
      }

      .log-controls-buttons {
        display: flex;
        gap: 8px;
      }

      #toggleAutoScroll {
        background: #28a745;
        padding: 6px 12px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-weight: 600;
        color: white;
        transition: all 0.2s;
        font-size: 12px;
      }

      #toggleAutoScroll:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      #toggleAutoScroll.disabled {
        background: #dc3545;
      }

      #clearLog {
        background: #6c757d;
        padding: 6px 12px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-weight: 600;
        color: white;
        transition: all 0.2s;
        font-size: 12px;
      }

      #clearLog:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .ui-ctnt {
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 0 0 6px 6px;
        flex: 1;
        overflow: auto;
        background: #fafafa;
        font-family: "Courier New", monospace;
      }

      th,
      td {
        padding: 4px 8px;
        border-spacing: 0;
        font-size: 13px;
      }

      td:first-child {
        font-weight: 500;
        color: #555;
        white-space: nowrap;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      tr {
        border-bottom: 1px solid #f0f0f0;
      }

      tr:last-child {
        border-bottom: none;
      }

      /* Button Styles */
      input[type="button"] {
        padding: 6px 12px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        color: white;
        font-size: 12px;
      }

      input[type="button"]:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      #sendSess {
        background: #28a745;
      }
      #sendAck {
        background: #ffc107;
        color: #000;
      }
      #sendRM,
      #sendIdxDet {
        background: #0d6efd;
      }
      #sendRF,
      #sendRQ,
      #sendRV {
        background: #198754;
      }
      #sendRS,
      #sendLI {
        background: #dc3545;
      }
      #sendRP,
      #sendSS {
        background: #6f42c1;
      }
      #send {
        background: #007bff;
      }

      select,
      input[type="text"] {
        padding: 4px 6px;
        border: 1px solid #ddd;
        border-radius: 3px;
        font-size: 13px;
      }

      select {
        min-width: 120px;
      }

      /* Message Styling */
      .message-container {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 4px;
        border-left: 3px solid #667eea;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
        padding-bottom: 4px;
        border-bottom: 1px solid #e0e0e0;
      }

      .message-type {
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 2px;
        font-size: 13px;
        text-transform: uppercase;
      }

      .message-timestamp {
        font-size: 12px;
        color: #666;
        font-family: monospace;
        font-weight: bold;
      }

      .message-body {
        font-family: "Courier New", monospace;
        font-size: 15px;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.4;
      }

      /* Message Type Colors */
      .mt-connect {
        background: #d4edda;
        border-left-color: #28a745;
      }
      .mt-disconnect {
        background: #f8d7da;
        border-left-color: #dc3545;
      }
      .mt-error {
        background: #fff3cd;
        border-left-color: #ffc107;
      }
      .mt-sent {
        background: #e7f3ff;
        border-left-color: #007bff;
      }
      .mt-LG {
        background: #d4edda;
        border-left-color: #28a745;
      }
      .mt-AC {
        background: #fff3cd;
        border-left-color: #ffc107;
      }
      .mt-RM {
        background: #cfe2ff;
        border-left-color: #0d6efd;
      }
      .mt-RI {
        background: #cfe2ff;
        border-left-color: #0d6efd;
      }
      .mt-RF {
        background: #d1e7dd;
        border-left-color: #198754;
      }
      .mt-RQ {
        background: #d1e7dd;
        border-left-color: #198754;
      }
      .mt-RV {
        background: #d1e7dd;
        border-left-color: #198754;
      }
      .mt-RS {
        background: #f8d7da;
        border-left-color: #dc3545;
      }
      .mt-LI {
        background: #f8d7da;
        border-left-color: #dc3545;
      }
      .mt-RP {
        background: #e2d9f3;
        border-left-color: #6f42c1;
      }
      .mt-SS {
        background: #e2d9f3;
        border-left-color: #6f42c1;
      }

      .type-LG {
        background: #28a745;
        color: white;
      }
      .type-AC {
        background: #ffc107;
        color: black;
      }
      .type-RM {
        background: #0d6efd;
        color: white;
      }
      .type-RI {
        background: #0d6efd;
        color: white;
      }
      .type-RF {
        background: #198754;
        color: white;
      }
      .type-RQ {
        background: #198754;
        color: white;
      }
      .type-RV {
        background: #198754;
        color: white;
      }
      .type-RS {
        background: #dc3545;
        color: white;
      }
      .type-LI {
        background: #dc3545;
        color: white;
      }
      .type-RP {
        background: #6f42c1;
        color: white;
      }
      .type-SS {
        background: #6f42c1;
        color: white;
      }
      .type-connect {
        background: #28a745;
        color: white;
      }
      .type-disconnect {
        background: #dc3545;
        color: white;
      }
      .type-error {
        background: #ffc107;
        color: black;
      }
      .type-sent {
        background: #17a2b8;
        color: white;
      }

      /* JSON Syntax Highlighting */
      .json-key {
        color: #881391;
        font-weight: bold;
      }
      .json-string {
        color: #1a1aa6;
      }
      .json-number {
        color: #1c00cf;
      }
      .json-boolean {
        color: #0d47a1;
        font-weight: bold;
      }
      .json-null {
        color: #808080;
        font-style: italic;
      }
    </style>
  </head>

  <body>
    <h1>SMISWS Client - Socket.IO</h1>
    <div class="ui-cntnr">
      <table>
        <tr>
          <td>Create Session with SMISWS Server:</td>
          <td>
            <input id="sendSess" type="button" value="Request Session" />
          </td>
        </tr>
        <tr>
          <td>Send Hearbeat:</td>
          <td>
            <input id="sendAck" type="button" value="Request Acknowledgment" />
          </td>
        </tr>
        <tr>
          <td>JSON message to send:</td>
          <td colspan="2">
            <input id="msg" type="text" class="ui-txt" />
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <input id="send" type="button" value="Send" />
          </td>
        </tr>
        <tr>
          <td>Market Info:</td>
          <td>
            <input id="sendRM" type="button" value="Request Market Info" />
          </td>
        </tr>
        <tr>
          <td>Index Detail:</td>
          <td>
            <select id="optIndex">
              <option value="100">DSEX</option>
              <option value="101">DSE30</option>
              <option value="102">DSES</option>
              <option value="1816">DSMEX</option>
              <option value="1733">ATBX</option>
            </select>
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <input id="sendIdxDet" type="button" value="Request Index Detail" />
          </td>
        </tr>
        <tr>
          <td>Market Trade:</td>
          <td>
            <input
              id="sendRF"
              type="button"
              value="Request Market Trade Info"
            />
          </td>
        </tr>
        <tr>
          <td>Board</td>
          <td>
            <select id="optBoard">
              <option value="100">MAIN</option>
              <option value="200">SME</option>
              <option value="300">ATB</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Group</td>
          <td>
            <select id="optGroup">
              <option value="0">All</option>
              <option value="1">Public</option>
              <option value="2">Block</option>
              <option value="3">Buy In</option>
              <option value="4">Debt</option>
              <option value="5">Buy Debt</option>
              <option value="6">Yield Debt</option>
              <option value="7">Alt Debt</option>
              <!-- <option value="8">Buy Back</option>
            <option value="9">Foreign</option> -->
            </select>
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <input
              id="sendRQ"
              type="button"
              value="Request Sector Detail Info"
            />
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <input id="sendRV" type="button" value="Request Sector Summary" />
          </td>
        </tr>
        <tr>
          <td>Status</td>
          <td>
            <select id="optStatus">
              <option value="U">Up</option>
              <option value="D">Down</option>
              <option value="C">Unchange</option>
              <option value="T">Untrade</option>
              <option value="S">Suspend</option>
              <option value="?">Unknown</option>
              <option value="A" selected>All</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Sort Order</td>
          <td>
            <select id="optSortOrder">
              <option value="0">Ascending</option>
              <option value="1">Descending</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Sort by</td>
          <td>
            <select id="optSortBy">
              <option value="0">StockName</option>
              <option value="1">StockCode</option>
              <option value="2">ClosePrice</option>
              <option value="3">LastDonePrice</option>
              <option value="4">Change</option>
              <option value="5">ChangePercent</option>
              <option value="6">VolumeTraded</option>
              <option value="7">BuyRate</option>
              <option value="8">StockLongName</option>
              <option value="10">ISIN</option>
              <option value="11">ValueTraded</option>
            </select>
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <input id="sendSS" type="button" value="Search Stock" />
          </td>
        </tr>
        <tr>
          <td>Stock Group:</td>
          <td>
            <select id="optStockGroup" onchange="javascript:showStockGroup()">
              <option value="0">Active</option>
              <option value="1">Gainer</option>
              <option value="2">Gainer Percent</option>
              <option value="3">Loser</option>
              <option value="4">Loser Percent</option>
              <option value="23">Main Public</option>
              <option value="255">List Stock</option>
            </select>
          </td>
          <td>
            <input
              type="text"
              id="txtStockGroup"
              value="Stock Name..."
              style="display: none"
            />
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <input id="sendRS" type="button" value="Request Stock Info" />
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <input id="sendLI" type="button" value="Request Stock Ranking" />
          </td>
        </tr>
        <tr>
          <td>Stock:</td>
          <td>
            <input type="text" id="txtStock" />
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <input id="sendRP" type="button" value="Request Market Depth" />
          </td>
        </tr>
      </table>
    </div>
    <div class="log-container">
      <div class="log-controls">
        <h3>üìã Message Log</h3>
        <div class="log-controls-buttons">
          <button id="toggleAutoScroll">üîÑ Auto-Scroll: ON</button>
          <button id="clearLog">üóëÔ∏è Clear Log</button>
        </div>
      </div>
      <section id="ctnt" class="ui-ctnt"></section>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
      let autoScroll = true;

      var socket = io("http://localhost:3000", {
        transports: ["websocket", "polling"],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5,
      });

      // Socket.IO event handlers
      socket.on("connect", function () {
        console.log("Socket.IO connected to bridge server");
        displaySystemMessage("Connection established", "connect");
      });

      socket.on("connect_status", function (data) {
        console.log("Bridge status:", data);
        displaySystemMessage("Bridge: " + data.message, "connect");
      });

      socket.on("message", function (data) {
        console.log("onmessage");
        console.log(data);

        let messageType = "RECEIVED";
        let messageClass = "";

        // Try to parse message type
        if (typeof data === "object" && data.mt) {
          messageType = data.mt;
          messageClass = "mt-" + data.mt;
        }

        displayFormattedMessage(data, messageType, messageClass, "received");
      });

      socket.on("disconnect", function () {
        console.log("Socket.IO disconnected");
        displaySystemMessage("Connection closed", "disconnect");
      });

      socket.on("error", function (error) {
        console.log("Socket.IO error");
        console.log(error);
        displaySystemMessage("Error: " + error.message, "error");
      });

      socket.on("connect_error", function (error) {
        console.log("Connection error");
        console.log(error);
        displaySystemMessage("Connection error: " + error.message, "error");
      });

      // Helper function to emit messages
      function emitMessage(data) {
        if (socket.connected) {
          socket.emit("message", data);

          // Display sent message
          let parsedData;
          try {
            parsedData = typeof data === "string" ? JSON.parse(data) : data;
          } catch (e) {
            parsedData = data;
          }

          let messageType = "SENT";
          let messageClass = "mt-sent";

          if (parsedData && parsedData.mt) {
            messageType = parsedData.mt + " (SENT)";
            messageClass = "mt-" + parsedData.mt;
          }

          displayFormattedMessage(
            parsedData,
            messageType,
            messageClass,
            "sent"
          );
        } else {
          console.error("Socket not connected");
          displaySystemMessage("Error: Socket not connected", "error");
        }
      }

      // Control buttons
      document
        .getElementById("toggleAutoScroll")
        .addEventListener("click", function () {
          autoScroll = !autoScroll;
          const btn = document.getElementById("toggleAutoScroll");
          if (autoScroll) {
            btn.textContent = "üîÑ Auto-Scroll: ON";
            btn.classList.remove("disabled");
            // Scroll to bottom when re-enabled
            const ctnt = document.getElementById("ctnt");
            if (ctnt) ctnt.scrollTop = ctnt.scrollHeight;
          } else {
            btn.textContent = "‚è∏Ô∏è Auto-Scroll: OFF";
            btn.classList.add("disabled");
          }
        });

      document
        .getElementById("clearLog")
        .addEventListener("click", function () {
          clrCtnt();
        });

      // login
      document
        .getElementById("sendSess")
        .addEventListener("click", function () {
          console.log("mt:LG");
          clrCtnt();
          var loginData =
            '{"data":{"16":"mt010","37":4325,"271":"505ae561111b6bfd3fad9f3badb0d8ca200eefaf1dfbb2310f58d6c710acbbba","64":196608,"65":3},"mt":"LG"}';
          emitMessage(loginData);
          setInterval(sendAck, 5000);
          clrReqTxt();
        });

      // acknowledgement
      document.getElementById("sendAck").addEventListener("click", function () {
        clrCtnt();
        sendAck();
        clrReqTxt();
      });

      // send JSON message
      document.getElementById("send").addEventListener("click", function () {
        clrCtnt();
        var msg = document.getElementById("msg");
        console.log(msg.value);
        if (msg !== null && msg.value) emitMessage(msg.value);
        clrReqTxt();
      });

      // market info
      document.getElementById("sendRM").addEventListener("click", function () {
        console.log("mt:RM");
        clrCtnt();
        emitMessage('{"data":"X","mt":"RM"}');
        clrReqTxt();
      });

      // index detail on each minute
      document
        .getElementById("sendIdxDet")
        .addEventListener("click", function () {
          console.log("mt:RI");
          clrCtnt();
          let optIndexName = document.getElementById("optIndex");
          let idxVal = optIndexName[optIndexName.selectedIndex].value;
          console.log(idxVal);
          emitMessage(`{"data":{"23":${idxVal},"24":0,"29":0},"mt":"RI"}`);
          clrReqTxt();
        });

      // market trade info
      document.getElementById("sendRF").addEventListener("click", function () {
        console.log("mt:RF");
        clrCtnt();
        emitMessage('{"data":{"42":1},"mt":"RF"}');
        clrReqTxt();
      });

      // sector detail info
      document.getElementById("sendRQ").addEventListener("click", function () {
        console.log("mt:RQ");
        clrCtnt();

        let optBoardName = document.getElementById("optBoard");
        let optGroupName = document.getElementById("optGroup");

        let optBoardVal = optBoardName[optBoardName.selectedIndex].value;
        let optGroupVal = optGroupName[optGroupName.selectedIndex].value;

        if (optGroupVal == 0) {
          // all group of selected board is choosen
          emitMessage(`{"data":{"6":${optBoardVal},"29":-1},"mt":"RQ"}`);
        } else {
          // find specific group under the board
          let secCode = parseInt(optBoardVal) + parseInt(optGroupVal);
          console.log(secCode);
          emitMessage(`{"data":{"6":${secCode},"29":-1},"mt":"RQ"}`);
        }
        clrReqTxt();
      });

      // sector summary
      document.getElementById("sendRV").addEventListener("click", function () {
        console.log("mt:RV");
        clrCtnt();

        let optBoardName = document.getElementById("optBoard");
        let optGroupName = document.getElementById("optGroup");

        let optBoardVal = optBoardName[optBoardName.selectedIndex].value;
        let optGroupVal = optGroupName[optGroupName.selectedIndex].value;

        if (optGroupVal == 0) {
          // all group of selected board is choosen
          emitMessage(`{"data":{"6":${optBoardVal}},"mt":"RV"}`);
        } else {
          // find specific group under the board
          let secCode = parseInt(optBoardVal) + parseInt(optGroupVal);
          console.log(secCode);
          emitMessage(`{"data":{"6":${secCode}},"mt":"RV"}`);
        }
        clrReqTxt();
      });

      // stock info
      document.getElementById("sendRS").addEventListener("click", function () {
        console.log("mt:RS");
        clrCtnt();

        let optStockGroupName = document.getElementById("optStockGroup");
        let stockGroupVal =
          optStockGroupName[optStockGroupName.selectedIndex].value;
        console.log(stockGroupVal);
        if (stockGroupVal != 255) {
          emitMessage(
            `{"data":{"20":${stockGroupVal},"52":0,"66":1,"67":1,"229":0,"21":[1],"60":[1],"69":[1]},"mt":"RS"}`
          );
        } else {
          let txtStockGroupName = document.getElementById("txtStockGroup");
          if (txtStockGroupName.value == "") {
            alert("Enter Stock Name");
            txtStockGroupName.focus();
            return;
          }
          emitMessage(
            `{"data":{"20":${stockGroupVal},"52":0,"66":1,"67":1,"229":1,"2":["${txtStockGroupName.value}"],"21":[1],"60":[1],"69":[1]},"mt":"RS"}`
          );
        }
        clrReqTxt();
      });

      // stock ranking
      document.getElementById("sendLI").addEventListener("click", function () {
        console.log("mt:LI");
        clrCtnt();
        let optStockGroupName = document.getElementById("optStockGroup");
        let stockGroupVal =
          optStockGroupName[optStockGroupName.selectedIndex].value;
        console.log(stockGroupVal);
        if (stockGroupVal != 255) {
          emitMessage(
            `{"data":{"20":${stockGroupVal},"52":1,"66":1,"67":1,"229":0},"mt":"LI"}`
          );
        } else {
          alert("This option is not valid for Stock Ranking");
          optStockGroupName.focus();
          return;
        }
        clrReqTxt();
      });

      // market depth
      document.getElementById("sendRP").addEventListener("click", function () {
        let txtStockName = document.getElementById("txtStock");
        if (txtStockName.value == "") {
          alert("Enter Stock Name");
          txtStockName.focus();
          return;
        }
        console.log("mt:RP");
        clrCtnt();
        emitMessage(
          `{"data":{"66":122,"67":1,"2":"${txtStockName.value}"},"mt":"RP"}`
        );
        clrReqTxt();
      });

      // search stock
      document.getElementById("sendSS").addEventListener("click", function () {
        console.log("mt:SS");
        clrCtnt();

        let optBoardName = document.getElementById("optBoard");
        let optGroupName = document.getElementById("optGroup");

        let optBoardVal = optBoardName[optBoardName.selectedIndex].value;
        let optGroupVal = optGroupName[optGroupName.selectedIndex].value;
        let secCode = parseInt(optBoardVal) + parseInt(optGroupVal);

        let optStatusName = document.getElementById("optStatus");
        let optSortOrderName = document.getElementById("optSortOrder");
        let optSortByName = document.getElementById("optSortBy");

        let optStatusVal = optStatusName[optStatusName.selectedIndex].value;
        let optSortOrderVal =
          optSortOrderName[optSortOrderName.selectedIndex].value;
        let optSortByVal = optSortByName[optSortByName.selectedIndex].value;

        let searchCond2 = makeWord(optStatusVal, secCode);
        console.log(searchCond2);
        let searchCond3 = makeWord(
          parseInt(optSortOrderVal),
          parseInt(optSortByVal)
        );
        console.log(searchCond3);

        console.log(
          `{"data":{"66":144,"44":0,"45":0,"46":${searchCond2},"47":${searchCond3}},"mt":"SS"}`
        );
        emitMessage(
          `{"data":{"66":144,"44":0,"45":0,"46":${searchCond2},"47":${searchCond3}},"mt":"SS"}`
        );
        clrReqTxt();
      });

      function sendAck() {
        console.log("mt:AC");
        emitMessage('{"mt":"AC","data":{}}');
      }

      // Message Display Functions
      function displayFormattedMessage(
        data,
        messageType,
        messageClass,
        direction
      ) {
        const ctnt = document.getElementById("ctnt");
        if (!ctnt) return;

        const timestamp = new Date().toLocaleTimeString("en-US", {
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          fractionalSecondDigits: 3,
        });

        const messageDiv = document.createElement("div");
        messageDiv.className = "message-container " + messageClass;

        const typeClass = "type-" + messageType.split(" ")[0];
        const directionIcon = direction === "sent" ? "‚ñ≤" : "‚ñº";

        messageDiv.innerHTML = `
          <div class="message-header">
            <span class="message-type ${typeClass}">${directionIcon} ${messageType}</span>
            <span class="message-timestamp">${timestamp}</span>
          </div>
          <div class="message-body">${formatJSON(data)}</div>
        `;

        ctnt.appendChild(messageDiv);
        if (autoScroll) {
          ctnt.scrollTop = ctnt.scrollHeight;
        }
      }

      function displaySystemMessage(message, type) {
        const ctnt = document.getElementById("ctnt");
        if (!ctnt) return;

        const timestamp = new Date().toLocaleTimeString("en-US", {
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        const messageDiv = document.createElement("div");
        messageDiv.className = "message-container mt-" + type;

        messageDiv.innerHTML = `
          <div class="message-header">
            <span class="message-type type-${type}">‚óè ${type.toUpperCase()}</span>
            <span class="message-timestamp">${timestamp}</span>
          </div>
          <div class="message-body">${message}</div>
        `;

        ctnt.appendChild(messageDiv);
        if (autoScroll) {
          ctnt.scrollTop = ctnt.scrollHeight;
        }
      }

      function formatJSON(data) {
        if (typeof data !== "object") {
          return escapeHtml(String(data));
        }

        try {
          const jsonString = JSON.stringify(data, null, 2);
          return syntaxHighlight(jsonString);
        } catch (e) {
          return escapeHtml(String(data));
        }
      }

      function syntaxHighlight(json) {
        json = json
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

        return json.replace(
          /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
          function (match) {
            let cls = "json-number";
            if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                cls = "json-key";
              } else {
                cls = "json-string";
              }
            } else if (/true|false/.test(match)) {
              cls = "json-boolean";
            } else if (/null/.test(match)) {
              cls = "json-null";
            }
            return '<span class="' + cls + '">' + match + "</span>";
          }
        );
      }

      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, function (m) {
          return map[m];
        });
      }

      function clrCtnt() {
        var ctnt = document.getElementById("ctnt");
        if (ctnt !== null) ctnt.innerHTML = "";
      }

      function clrReqTxt() {
        var msg = document.getElementById("msg");
        if (msg !== null) msg.value = "";
      }

      // Old dispCtnt kept for compatibility but now uses new format
      function dispCtnt(d) {
        displaySystemMessage(d, "info");
      }

      function makeWord(loword, hiword) {
        console.log(loword);
        console.log(hiword);

        if (isNaN(loword)) loword = loword.charCodeAt(0);
        console.log(loword);

        hiword = hiword << 16;
        console.log(hiword);

        loword += hiword;
        console.log(loword);
        return loword;
      }

      function showStockGroup() {
        let optStockGroupName = document.getElementById("optStockGroup");
        let idxVal = optStockGroupName[optStockGroupName.selectedIndex].value;
        if (idxVal == 255) {
          document.getElementById("txtStockGroup").style.display = "block";
          document.getElementById("txtStockGroup").focus();
          document.getElementById("txtStockGroup").select();
        } else {
          document.getElementById("txtStockGroup").style.display = "none";
        }
      }
    </script>
  </body>
</html>
